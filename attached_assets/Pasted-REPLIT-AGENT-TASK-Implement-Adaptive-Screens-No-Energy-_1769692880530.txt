REPLIT AGENT TASK â€” Implement â€œAdaptive Screensâ€ (No-Energy, Post-Session Feel, Returning After Break, Phase Transition, Progress Reflection)

Goal:
Add a lightweight â€œadaptive UX layerâ€ that shows specific screens based on user state + recent activity, and stores user feedback to influence tomorrowâ€™s session.

Scope:
- Add user_state tracking (last session date, last feedback, weekly count)
- Add 5 screens (components) + routing logic
- Store â€œHow did that feel?â€ after every session
- Adjust next session intensity flag based on feedback + low-energy days
- Keep it simple: no charts, no complex analytics

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1) DATA MODEL / TYPES

A) Add (or extend) a UserState type in shared types (e.g. /shared/types.ts or /client/src/types.ts)

type Phase = "PRE_TREATMENT" | "IN_TREATMENT" | "POST_TREATMENT";

type SessionFeedback = "COMFORTABLE" | "A_BIT_TIRING" | "TOO_MUCH";

type UserState = {
  userId: string;

  phase: Phase;
  phaseChangedAt?: string;          // ISO date
  phaseTransitionSeenAt?: string;   // ISO date (so we show transition screen once)

  lastSessionAt?: string;           // ISO date
  lastSessionFeedback?: SessionFeedback;
  lastSessionFeedbackAt?: string;   // ISO date

  // quick weekly counters (server can compute from session logs later, but start simple)
  weekSessionCount?: number;        // number of completed sessions in last 7 days
  weekWindowStart?: string;         // ISO date

  // symptom snapshot from today check (already exists? if yes, map to these)
  todayEnergy?: "LOW" | "OKAY" | "GOOD";
  todayComfort?: "UNCOMFORTABLE" | "MANAGEABLE" | "COMFORTABLE";
  todayConfidence?: "LOW" | "SOME" | "READY";

  // flags computed by server for UX decisions (optional)
  needsNoEnergyFlow?: boolean;
  needsReturnAfterBreak?: boolean;
  needsPhaseTransition?: boolean;
};

B) If you already have tables for sessions/symptoms, donâ€™t refactor everything.
Just ensure we can store minimal fields somewhere (DB user table JSON column, or user_state table).
Preferred: user_state table keyed by userId.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2) SERVER ENDPOINTS

Add these endpoints (paths can match your existing API style):

GET  /api/user/state
- returns UserState including computed flags:
  - needsReturnAfterBreak: true if daysSince(lastSessionAt) >= 7
  - needsNoEnergyFlow: true if todayEnergy === "LOW" OR other simple symptom threshold you already use
  - needsPhaseTransition: true if phaseChangedAt exists AND phaseTransitionSeenAt is null (or older than phaseChangedAt)

POST /api/session/complete
body: { sessionId: string, completedAt: string }
- updates lastSessionAt = completedAt
- increments weekSessionCount (rolling 7 days)
- (optional) also writes to sessions log table if you have one

POST /api/session/feedback
body: { feedback: "COMFORTABLE" | "A_BIT_TIRING" | "TOO_MUCH", at: string }
- updates lastSessionFeedback + lastSessionFeedbackAt
- sets a simple â€œtomorrowAdjustmentâ€ flag in user_state if needed:
    if feedback === "TOO_MUCH" => tomorrowAdjustment = "LIGHTER"
    if feedback === "A_BIT_TIRING" => tomorrowAdjustment = "SAME"
    if feedback === "COMFORTABLE" => tomorrowAdjustment = "GENTLE_BUILD" (optional)
- return updated UserState

POST /api/user/phase-transition/seen
body: { seenAt: string }
- sets phaseTransitionSeenAt = seenAt

Note:
If you already have a â€œtodayâ€ endpoint returning plan/session, add these computed flags to that response instead of creating new endpoints. Keep minimal.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3) CLIENT: SCREEN COMPONENTS (UI COPY MUST MATCH EXACTLY)

Create these components under something like:
 /client/src/components/adaptive/
(or /client/src/pages/adaptive/)

A) NoEnergyDayScreen.tsx
Title: â€œLow energy days happen.â€
Body:
â€œLetâ€™s keep things very gentle today.
A few minutes of breathing and light mobility can help your body without draining you.â€
Primary button: â€œStart gentle sessionâ€
Secondary text (small): â€œRest is also a positive step.â€

Optional audio hooks:
Show 1â€“2 links/buttons if available:
- â€œPlay 2-minute breathing resetâ€
- â€œPlay â€˜Youâ€™re doing enoughâ€™â€
(If no audio URLs yet, stub with TODO and hide unless URLs exist.)

B) ReturningAfterBreakScreen.tsx
Title: â€œWelcome backâ€
Body:
â€œItâ€™s completely normal to have gaps.
Letâ€™s ease back in gently today.
Weâ€™ll start with a lighter session to help your body settle.â€
Primary button: â€œStart gentle sessionâ€
Small text: â€œThereâ€™s no catching up needed.â€

C) PhaseTransitionScreen.tsx
Title: â€œYouâ€™re entering a new phaseâ€
Body:
â€œYour body is ready for a slightly more progressive focus.
Weâ€™ll still adjust sessions based on how you feel each day.â€
Bullets:
â€œâ€¢ Slightly longer sessions
â€¢ Gentle strength building
â€¢ Continued flexibility on low daysâ€
Primary button: â€œContinueâ€
On click: POST /api/user/phase-transition/seen

D) ProgressReflectionScreen.tsx
Title: â€œYour recent patternâ€
Body lines:
â€œğŸŒ¿ Youâ€™ve been supporting your body regularly.
Small steps are adding up.â€
Then:
â€œYouâ€™ve completed sessions focused on:
â€¢ Mobility
â€¢ Light strength
â€¢ Recoveryâ€
Primary button: â€œContinueâ€

E) PostSessionFeelScreen.tsx   (THIS MUST APPEAR AFTER EVERY SESSION)
Title: â€œHow did that feel for your body?â€
Options (radio / big buttons):
- â€œComfortableâ€
- â€œA bit tiringâ€
- â€œToo much todayâ€
Helper small text:
â€œYour answer helps us adjust future sessions.â€
Primary button: â€œContinueâ€
On Continue: POST /api/session/feedback with selected value, then route to SessionComplete screen (or your existing completion).

Also add the â€œsmart follow-up microcopyâ€ AFTER selection (optional, tiny line under options):
If Comfortable: â€œGreat â€” weâ€™ll keep building gently.â€
If A bit tiring: â€œGood to notice. Weâ€™ll stay at a similar level.â€
If Too much today: â€œThanks for letting us know. Weâ€™ll make tomorrow lighter.â€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4) CLIENT: DECISION LOGIC (ONE PLACE, EASY TO MAINTAIN)

Create a simple resolver function:
 /client/src/lib/adaptiveFlow.ts

Inputs: UserState + (optional) TodayPlan/Session context
Output: { screen: "PHASE_TRANSITION" | "RETURNING" | "NO_ENERGY" | "PROGRESS_REFLECTION" | "NONE" }

Priority order (important):
1) needsPhaseTransition  -> PhaseTransitionScreen
2) needsReturnAfterBreak -> ReturningAfterBreakScreen
3) needsNoEnergyFlow     -> NoEnergyDayScreen
4) weekly checkpoint (e.g. once per week on Monday OR after N sessions) -> ProgressReflectionScreen
5) none -> normal Today Card

Implementation notes:
- weekly checkpoint can be simple: show ProgressReflection if weekSessionCount >= 1 AND last shown more than 7 days ago (store progressReflectionSeenAt in user_state if you want). If you donâ€™t want more fields now, skip this and add later.

Then wire it in your Home / Today route:
- On app load, fetch /api/user/state (or use existing â€œtodayâ€ endpoint)
- Run resolver
- If resolver returns a screen, render that screen instead of the normal Home content

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5) SESSION FLOW INTEGRATION

Wherever a session ends (your current â€œComplete sessionâ€ action):
- Call POST /api/session/complete
- Immediately route to PostSessionFeelScreen (always)
- After feedback submitted -> show your existing â€œSession completeâ€ screen (the calm one)

This gives you the loop:
Session -> Feedback -> Completion -> Tomorrow adjustment

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
6) TOMORROW ADJUSTMENT (MINIMAL ENGINE HOOK)

In the endpoint that generates tomorrowâ€™s session (or todayâ€™s plan):
- If user_state.lastSessionFeedback === "TOO_MUCH" within last 24â€“48h OR needsNoEnergyFlow is true:
    return a â€œgentle session variantâ€ (shorter duration, easier exercises)
- Else normal selection

Do NOT build full AI logic. Just 2â€“3 branches.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
7) ACCEPTANCE CHECKLIST

- [ ] Home route shows PhaseTransition once after phase change, then stops showing it
- [ ] If no sessions in 7+ days, â€œWelcome backâ€ screen appears, then user can start gentle session
- [ ] If energy is LOW, NoEnergyDay screen appears and can launch gentle session
- [ ] After every session, the â€œHow did that feel?â€ screen appears and stores feedback
- [ ] â€œToo much todayâ€ results in lighter plan next time (visible effect)
- [ ] All copy matches exactly, including: â€œSmall steps are adding up.â€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
8) OPTIONAL: AUDIO LINK STUB

Add a config object:
const AUDIOS = {
  breathingReset2m: { title: "2-minute breathing reset", url: "" },
  enoughToday: { title: "Youâ€™re doing enough", url: "" },
};

Only render audio buttons if url is non-empty.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Deliverable:
- PR with the new endpoints, the new components, and the adaptiveFlow resolver wired into Home + post-session flow.
- Keep UI styling consistent with existing design system (cards, spacing, large buttons).
- No charts. No sliders. Big tap targets. Calm copy.
